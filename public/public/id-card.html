<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Entry Passes | LBRCE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&family=Space+Grotesk:wght@300;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        mono: ['Space Grotesk', 'monospace'] 
                    },
                    colors: { lbrce: { blue: '#003366', dark: '#002244', accent: '#FFB800' } },
                    backgroundImage: {
                        'security-pattern': "radial-gradient(#003366 0.5px, transparent 0.5px), radial-gradient(#003366 0.5px, #ffffff 0.5px)"
                    }
                }
            }
        }
    </script>
    <style>
        .security-bg {
            background-color: #ffffff;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .holo-strip {
            background: linear-gradient(135deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 70%);
            background-size: 200% 200%;
            animation: shine 3s infinite;
        }
        @keyframes shine {
            0% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; padding: 0 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .id-card { 
                box-shadow: none !important; 
                border: 1px solid #cbd5e1 !important; 
                margin: 0 auto; 
                page-break-after: always;
                page-break-inside: avoid;
            }
        }
        
        .id-card { width: 380px; height: 620px; position: relative; overflow: hidden; }
    </style>
</head>
<body class="bg-slate-100 flex flex-col items-center p-10 min-h-screen">

    <div id="loader" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center text-center">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-slate-200 border-t-lbrce-accent rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-8 h-8 bg-lbrce-blue rounded-full"></div>
            </div>
        </div>
        <p class="mt-4 text-lbrce-blue font-bold uppercase tracking-widest text-xs animate-pulse">Generating Secure Passes...</p>
    </div>

    <div id="controls" class="no-print mb-10 flex gap-4 sticky top-5 z-40">
        <button onclick="window.print()" class="bg-lbrce-blue hover:bg-lbrce-dark text-white px-8 py-3 rounded-full font-bold text-xs uppercase tracking-widest flex items-center gap-2 shadow-xl shadow-lbrce-blue/30 transition-all transform hover:-translate-y-1">
            <i class="ph ph-printer text-lg"></i> Print Passes
        </button>
        <a href="status.html" class="bg-white text-slate-500 hover:text-lbrce-blue px-8 py-3 rounded-full font-bold text-xs uppercase tracking-widest border border-slate-200 shadow-sm transition-all hover:bg-slate-50">Back</a>
    </div>

    <div id="card-list" class="flex flex-col gap-12 items-center pb-20"></div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script>
        async function loadCards() {
            const params = new URLSearchParams(window.location.search);
            const regId = params.get('id');
            const mode = params.get('mode');
            const leadEmail = params.get('email');

            if(!regId) return;

            try {
                const response = await fetch(`/api/registration-details/${regId}`);
                const data = await response.json();
                if(!data || data.error) throw new Error("Not Found");

                const participants = [];
                
                if(mode === 'bundle') {
                    participants.push({ name: data.leadName, roll: data.leadRoll, photo: data.photoUrl, role: 'Lead' });
                    (data.members || []).forEach(m => participants.push({ ...m, photo: m.photoUrl, role: 'Member' }));
                } else {
                    if (data.leadEmail === leadEmail) {
                        participants.push({ name: data.leadName, roll: data.leadRoll, photo: data.photoUrl, role: 'Lead' });
                    } else {
                        const m = (data.members || []).find(mem => mem.email === leadEmail);
                        if (m) {
                            participants.push({ ...m, photo: m.photoUrl, role: 'Member' });
                        }
                    }
                }

                const container = document.getElementById('card-list');
                
                if(participants.length === 0) {
                     container.innerHTML = `<div class="bg-white p-8 rounded-2xl shadow-lg text-center"><p class="text-slate-400 font-bold text-sm uppercase tracking-widest">No pass found for this account.</p></div>`;
                     document.getElementById('loader').classList.add('hidden');
                     return;
                }

                for(let i = 0; i < participants.length; i++) {
                    const p = participants[i];
                    const cardId = `qr-${i}`;
                    
                    const roleColor = p.role === 'Lead' ? 'bg-lbrce-accent text-lbrce-blue' : 'bg-slate-200 text-slate-600';
                    const roleIcon = p.role === 'Lead' ? 'ph-star-fill' : 'ph-user';

                    const cardHtml = `
                        <div class="id-card bg-white rounded-[20px] shadow-2xl flex flex-col font-sans security-bg relative">
                            
                            <!-- Watermark & Tech Elements -->
                            <div class="absolute inset-0 z-0 pointer-events-none">
                                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 mt-10 opacity-5">
                                    <img src="https://res.cloudinary.com/djdwpjm7x/image/upload/v1769925973/events_lbrce_logo_sefvzr.png" class="w-80 grayscale">
                                </div>
                                <div class="absolute top-[260px] left-6 w-6 h-6 border-l-2 border-t-2 border-slate-200 rounded-tl-lg"></div>
                                <div class="absolute top-[260px] right-6 w-6 h-6 border-r-2 border-t-2 border-slate-200 rounded-tr-lg"></div>
                                <div class="absolute bottom-24 left-6 w-6 h-6 border-l-2 border-b-2 border-slate-200 rounded-bl-lg"></div>
                                <div class="absolute bottom-24 right-6 w-6 h-6 border-r-2 border-b-2 border-slate-200 rounded-br-lg"></div>
                            </div>

                            <div class="absolute top-4 left-1/2 -translate-x-1/2 w-16 h-3 bg-slate-200 rounded-full z-20 overflow-hidden shadow-inner border border-slate-300"></div>

                            <div class="relative h-[240px] w-full overflow-hidden bg-lbrce-blue">
                                <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                                <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-black/20 to-transparent"></div>
                                <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-lbrce-accent rotate-45 opacity-20"></div>
                                <div class="absolute -right-16 -bottom-16 w-80 opacity-10 rotate-12 pointer-events-none">
                                    <img src="https://res.cloudinary.com/djdwpjm7x/image/upload/v1769925973/events_lbrce_logo_sefvzr.png" class="w-full brightness-0 invert">
                                </div>
                                
                                <div class="relative z-10 flex justify-between items-center p-6 pt-10">
                                    <img src="https://res.cloudinary.com/djdwpjm7x/image/upload/v1769925973/events_lbrce_logo_sefvzr.png" class="h-12 w-auto object-contain drop-shadow-lg opacity-95 bg-white/10 rounded px-2 py-1">
                                    <div class="text-right">
                                        <p class="text-[8px] text-white/60 font-mono uppercase tracking-widest">Event ID</p>
                                        <p class="text-white font-mono font-bold text-sm tracking-wider">${data.registrationId}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="absolute top-[180px] left-1/2 -translate-x-1/2 -translate-y-1/2 z-30">
                                <div class="relative w-36 h-36 rounded-full p-1.5 bg-white shadow-xl ring-1 ring-slate-100">
                                    <div class="w-full h-full rounded-full overflow-hidden bg-slate-100 relative">
                                        <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('${p.photo || ''}');"></div>
                                        <div class="${p.photo ? 'hidden' : 'flex'} w-full h-full items-center justify-center text-slate-300">
                                            <i class="ph ph-user text-6xl"></i>
                                        </div>
                                    </div>
                                    <div class="absolute bottom-1 right-1 bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center border-4 border-white shadow-md">
                                        <i class="ph-bold ph-check text-xs"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="flex-1 flex flex-col pt-20 px-6 items-center text-center relative z-10 w-full">
                                <div class="w-full px-4">
                                    <h1 class="text-2xl font-extrabold text-lbrce-blue uppercase leading-tight mb-2 tracking-tight line-clamp-2">${p.name}</h1>
                                </div>
                                <p class="font-mono text-sm text-slate-400 font-bold uppercase tracking-widest mb-4">${p.roll}</p>
                                
                                <div class="${roleColor} px-5 py-1.5 rounded-full flex items-center gap-2 mb-6 shadow-sm border border-white/50">
                                    <i class="ph-fill ${roleIcon} text-xs"></i>
                                    <span class="text-[10px] font-black uppercase tracking-[0.2em]">${p.role}</span>
                                </div>

                                <div class="w-full h-px bg-slate-200 mb-6 relative">
                                    <div class="absolute left-1/2 -translate-x-1/2 -top-1.5 bg-white px-2 text-slate-300 text-[10px] uppercase font-bold tracking-widest">Access</div>
                                </div>

                                <div class="grid grid-cols-2 gap-3 w-full mb-4 px-2">
                                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-left h-full flex flex-col justify-center bg-white/50 backdrop-blur-sm">
                                        <div class="flex items-center gap-2 mb-1.5 opacity-50">
                                            <i class="ph-duotone ph-calendar-check text-lbrce-blue"></i>
                                            <span class="text-[8px] font-bold uppercase tracking-wider text-slate-500">Event</span>
                                        </div>
                                        <p class="font-bold text-slate-800 text-[10px] leading-tight uppercase line-clamp-2">${data.eventName}</p>
                                    </div>
                                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-left h-full flex flex-col justify-center bg-white/50 backdrop-blur-sm">
                                        <div class="flex items-center gap-2 mb-1.5 opacity-50">
                                            <i class="ph-duotone ph-users-three text-lbrce-blue"></i>
                                            <span class="text-[8px] font-bold uppercase tracking-wider text-slate-500">Team</span>
                                        </div>
                                        <p class="font-bold text-lbrce-blue text-[10px] leading-tight uppercase line-clamp-2">${data.teamName || 'Single Entry'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="relative bg-slate-900 w-full px-6 py-4 flex items-center justify-between mt-auto overflow-hidden">
                                <div class="absolute inset-0 holo-strip opacity-20 pointer-events-none"></div>
                                <div class="flex flex-col text-left z-10">
                                    <span class="text-[7px] text-slate-400 uppercase tracking-widest font-mono mb-1">Authorization</span>
                                    <span class="text-[9px] text-white font-bold uppercase tracking-wider">Valid for Entry</span>
                                    <span class="text-[7px] text-lbrce-accent mt-0.5">LBRCE â€¢ ${new Date().getFullYear()}</span>
                                </div>

                                <div id="${cardId}" class="bg-white p-1.5 rounded-lg shadow-lg z-10 flex-shrink-0"></div>
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML += cardHtml;
                    
                    setTimeout(() => {
                        const qrCanvas = document.createElement('canvas');
                        // ADDED ?roll= TO MAKE EVERY QR UNIQUE
                        const verificationUrl = `${window.location.origin}/api/verify-attendance/${data.registrationId}?roll=${encodeURIComponent(p.roll)}`;
                        
                        QRCode.toCanvas(qrCanvas, verificationUrl, { 
                            width: 70, margin: 0, color: { dark: '#003366', light: '#ffffff' }
                        }, (err) => {
                            if(!err) document.getElementById(cardId).appendChild(qrCanvas);
                        });
                    }, 100);
                }

                document.getElementById('loader').classList.add('hidden');

            } catch (err) {
                document.getElementById('loader').innerHTML = `<p class="text-red-500 font-bold">Failed to load team passes: ${err.message}</p>`;
            }
        }
        window.onload = loadCards;
    </script>
</body>
</html>