<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Entry Passes | LBRCE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: { lbrce: { blue: '#003366', accent: '#FFB800' } }
                }
            }
        }
    </script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; padding: 0 !important; }
            .id-card { box-shadow: none !important; border: 1px solid #e2e8f0 !important; margin: 10px auto; page-break-inside: avoid; }
        }
        .id-card { width: 380px; height: 620px; background: white; position: relative; overflow: hidden; }
        .curve-header { position: absolute; top: 0; left: 0; width: 100%; height: 160px; background: #003366; clip-path: ellipse(80% 100% at 50% 0%); z-index: 0; }
    </style>
</head>
<body class="bg-slate-100 flex flex-col items-center p-10 min-h-screen">

    <div id="loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center text-center">
        <div class="w-12 h-12 border-4 border-lbrce-blue border-t-lbrce-accent rounded-full animate-spin mb-4"></div>
        <p class="text-lbrce-blue font-black uppercase tracking-widest text-xs">Assembling Identity Passes...</p>
    </div>

    <div id="controls" class="no-print mb-10 flex gap-4">
        <button onclick="window.print()" class="bg-lbrce-blue text-white px-8 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest flex items-center gap-2 shadow-xl hover:bg-lbrce-accent transition-all">
            <i class="ph ph-printer text-lg"></i> Print All ID Cards
        </button>
        <a href="status.html" class="bg-white text-gray-400 px-8 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest border border-gray-200">Back</a>
    </div>

    <div id="card-list" class="flex flex-col gap-10 items-center">
        <!-- Cards injected here -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script>
        async function loadCards() {
            const params = new URLSearchParams(window.location.search);
            const regId = params.get('id');
            const mode = params.get('mode'); // 'bundle' or null
            const leadEmail = params.get('email');

            if(!regId) return;

            try {
                const response = await fetch(`/api/registration-details/${regId}`);
                const data = await response.json();
                if(!data || data.error) throw new Error("Not Found");

                const participants = [];
                
                // Logic to populate participants based on mode (bundle or single view)
                if(mode === 'bundle') {
                    // Add Lead
                    participants.push({ name: data.leadName, roll: data.leadRoll, photo: data.photoUrl, role: 'Lead' });
                    // Add Members
                    (data.members || []).forEach(m => participants.push({ ...m, photo: m.photoUrl, role: 'Member' }));
                } else {
                    // Single View: Determine if Lead or Member matches the email
                    if (data.leadEmail === leadEmail) {
                        participants.push({ name: data.leadName, roll: data.leadRoll, photo: data.photoUrl, role: 'Lead' });
                    } else {
                        // FIX: Find member and map 'photoUrl' to 'photo' property
                        const m = (data.members || []).find(mem => mem.email === leadEmail);
                        if (m) {
                            participants.push({ ...m, photo: m.photoUrl, role: 'Member' });
                        }
                    }
                }

                const container = document.getElementById('card-list');
                
                // Handle case where no participant is found (e.g., mismatched email)
                if(participants.length === 0) {
                     container.innerHTML = `<div class="bg-white p-8 rounded-2xl shadow-lg text-center"><p class="text-slate-400 font-bold text-sm uppercase tracking-widest">No pass found for this account.</p></div>`;
                     document.getElementById('loader').classList.add('hidden');
                     return;
                }

                for(let i = 0; i < participants.length; i++) {
                    const p = participants[i];
                    const cardId = `qr-${i}`;
                    
                    const cardHtml = `
                        <div class="id-card rounded-[3rem] shadow-2xl flex flex-col items-center border border-gray-100 bg-white">
                            <div class="curve-header"></div>
                            <div class="relative z-10 pt-8 flex flex-col items-center">
                                <img src="https://res.cloudinary.com/djdwpjm7x/image/upload/v1769925973/events_lbrce_logo_sefvzr.png" class="h-10 w-auto invert brightness-200">
                                <div class="mt-3 px-3 py-1 bg-white/10 rounded-full border border-white/20">
                                    <span class="text-white text-[7px] font-black uppercase tracking-[0.3em]">Official Entry Pass</span>
                                </div>
                            </div>
                            <div class="relative z-10 mt-6 mb-3">
                                <div class="w-28 h-28 rounded-[2.2rem] bg-gray-50 border-4 border-white shadow-xl flex items-center justify-center overflow-hidden bg-cover bg-center" style="background-image: url('${p.photo || ''}');">
                                    <!-- Fallback Icon if Image Fails/Missing -->
                                    <i class="ph ph-user text-5xl text-gray-200 ${p.photo ? 'hidden' : 'block'}"></i>
                                </div>
                                <div class="absolute -bottom-1 -right-1 bg-green-500 text-white w-7 h-7 rounded-xl flex items-center justify-center border-2 border-white shadow-lg">
                                    <i class="ph ph-check-bold text-xs"></i>
                                </div>
                            </div>
                            <div class="text-center px-8 w-full mt-1">
                                <h1 class="text-xl font-black text-lbrce-blue tracking-tight leading-tight uppercase line-clamp-1">${p.name}</h1>
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-4">${p.roll}</p>
                                <div class="bg-gray-50/80 rounded-[1.8rem] p-4 border border-gray-100 space-y-2 text-left">
                                    <div>
                                        <p class="text-[7px] font-black text-gray-300 uppercase tracking-widest mb-0.5">Event Name</p>
                                        <p class="font-bold text-gray-800 text-[10px] uppercase truncate">${data.eventName}</p>
                                    </div>
                                    <div class="h-px bg-gray-200/50"></div>
                                    <div>
                                        <p class="text-[7px] font-black text-gray-300 uppercase tracking-widest mb-0.5">Team Identity</p>
                                        <p class="font-black text-lbrce-blue text-[10px] uppercase truncate">${data.teamName || 'Solo'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="w-full bg-lbrce-blue p-6 flex flex-col items-center rounded-t-[3rem] mt-auto">
                                <div id="${cardId}" class="bg-white p-2 rounded-2xl shadow-lg mb-3 border-4 border-white/10"></div>
                                <p class="text-white text-[7px] font-bold uppercase tracking-[0.4em] opacity-40">Registration ID: <span class="text-lbrce-accent opacity-100">${data.registrationId}</span></p>
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML += cardHtml;
                    
                    // Generate unique QR for each card
                    setTimeout(() => {
                        const qrCanvas = document.createElement('canvas');
                        QRCode.toCanvas(qrCanvas, `${window.location.origin}/api/verify-attendance/${data.registrationId}`, { 
                            width: 100, margin: 1, color: { dark: '#003366', light: '#ffffff' }
                        }, (err) => {
                            if(!err) document.getElementById(cardId).appendChild(qrCanvas);
                        });
                    }, 100);
                }

                document.getElementById('loader').classList.add('hidden');

            } catch (err) {
                document.getElementById('loader').innerHTML = `<p class="text-red-500 font-bold">Failed to load team passes: ${err.message}</p>`;
            }
        }
        window.onload = loadCards;
    </script>
</body>
</html>