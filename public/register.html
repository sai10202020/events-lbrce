<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Registration | LBRCE Events</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: { lbrce: { blue: '#003366', accent: '#FFB800', light: '#F8FAFC' } }
                }
            }
        }
    </script>
    <style>
        .step-content { display: none; }
        .step-content.active { display: block; }
        .progress-line { transition: width 0.7s cubic-bezier(0.65, 0, 0.35, 1); }
        .custom-loader { border-top-color: #FFB800; animation: spinner 0.6s linear infinite; }
        @keyframes spinner { to { transform: rotate(360deg); } }
        input:focus, select:focus { border-color: #FFB800; background: white; box-shadow: 0 0 0 4px rgba(255, 184, 0, 0.1); }
        .form-card { backdrop-filter: blur(10px); }
        
        /* Modal Styles */
        #custom-popup { display: none; align-items: center; justify-content: center; z-index: 100; }
        #custom-popup.active { display: flex; }
    </style>
</head>
<body class="bg-[#F8FAFC] min-h-screen py-6 sm:py-12 px-4 selection:bg-lbrce-accent selection:text-lbrce-blue overflow-x-hidden">

    <!-- CUSTOM POPUP MODAL -->
    <div id="custom-popup" class="fixed inset-0 bg-lbrce-blue/40 backdrop-blur-md px-4">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full shadow-2xl border border-slate-100 transform transition-all animate-in zoom-in-95 duration-300">
            <div id="popup-icon" class="w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="ph-bold ph-warning-circle text-3xl"></i>
            </div>
            <h3 id="popup-title" class="text-xl font-black text-lbrce-blue uppercase tracking-tight text-center mb-2">Notice</h3>
            <p id="popup-message" class="text-slate-500 text-sm font-bold text-center leading-relaxed mb-8"></p>
            <button id="popup-btn" onclick="closePopup()" class="w-full py-4 bg-lbrce-blue text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-lbrce-accent hover:text-lbrce-blue transition-all">Understood</button>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <!-- TOP NAVIGATION -->
        <div class="flex flex-col sm:flex-row justify-between items-center gap-6 mb-10 sm:mb-16">
            <a href="index.html" class="flex items-center gap-3 group self-start sm:self-auto">
                <div class="w-10 h-10 sm:w-11 sm:h-11 bg-white rounded-2xl shadow-sm border border-slate-100 flex items-center justify-center transition-all group-hover:border-lbrce-blue">
                    <i class="ph-bold ph-arrow-left text-lbrce-blue text-sm sm:text-base"></i>
                </div>
                <div class="text-left">
                    <p class="text-[9px] sm:text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] group-hover:text-lbrce-blue transition-colors leading-none">Abort & Return</p>
                    <p class="text-xs font-bold text-lbrce-blue mt-1">Portal Home</p>
                </div>
            </a>
            
            <div id="event-tag" class="hidden bg-lbrce-blue p-1 rounded-full shadow-xl shadow-blue-900/10 border border-white/10 flex items-center gap-3 pr-5 w-full sm:w-auto">
                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-white rounded-full flex items-center justify-center shadow-lg shrink-0">
                    <i class="ph-bold ph-calendar-check text-lbrce-blue text-sm sm:text-base"></i>
                </div>
                <span id="event-name-tag" class="text-[9px] sm:text-[10px] font-black text-white uppercase tracking-[0.2em] truncate"></span>
            </div>
        </div>

        <!-- PROGRESS TRACKER -->
        <div class="mb-12 sm:mb-20 relative max-w-2xl mx-auto px-2">
            <div class="h-1 sm:h-1.5 w-full bg-slate-200 rounded-full absolute top-5 sm:top-6 left-0 z-0">
                <div id="progress-bar" class="progress-line h-full bg-lbrce-blue w-[25%] rounded-full shadow-[0_0_20px_rgba(0,51,102,0.3)]"></div>
            </div>
            <div class="relative z-10 flex justify-between">
                <div class="group flex flex-col items-center gap-2 sm:gap-3">
                    <div class="step-node w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-lbrce-blue text-white flex items-center justify-center shadow-xl border-4 border-[#F8FAFC] transition-all" id="node-1"><i class="ph-bold ph-users-three text-sm"></i></div>
                    <span class="text-[8px] sm:text-[9px] font-black uppercase tracking-widest text-lbrce-blue">Team</span>
                </div>
                <div class="group flex flex-col items-center gap-2 sm:gap-3">
                    <div class="step-node w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-white text-slate-300 flex items-center justify-center border-4 border-[#F8FAFC] shadow-sm transition-all" id="node-2"><i class="ph-bold ph-crown text-sm"></i></div>
                    <span class="text-[8px] sm:text-[9px] font-black uppercase tracking-widest text-slate-400">Leader</span>
                </div>
                <div class="group flex flex-col items-center gap-2 sm:gap-3">
                    <div class="step-node w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-white text-slate-300 flex items-center justify-center border-4 border-[#F8FAFC] shadow-sm transition-all" id="node-3"><i class="ph-bold ph-identification-card text-sm"></i></div>
                    <span class="text-[8px] sm:text-[9px] font-black uppercase tracking-widest text-slate-400">Members</span>
                </div>
                <div class="group flex flex-col items-center gap-2 sm:gap-3">
                    <div class="step-node w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-white text-slate-300 flex items-center justify-center border-4 border-[#F8FAFC] shadow-sm transition-all" id="node-4"><i class="ph-bold ph-check-circle text-sm"></i></div>
                    <span class="text-[8px] sm:text-[9px] font-black uppercase tracking-widest text-slate-400">Review</span>
                </div>
            </div>
        </div>

        <!-- MAIN FORM -->
        <div class="bg-white rounded-[2.5rem] sm:rounded-[4rem] shadow-2xl shadow-blue-900/5 overflow-hidden border border-slate-100 form-card">
            <form id="multiStepForm" class="p-6 sm:p-12 md:p-24" onsubmit="return false;" autocomplete="off">
                
                <!-- STEP 1: TEAM -->
                <div id="step-1" class="step-content active animate-in fade-in slide-in-from-bottom-6 duration-700">
                    <div class="max-w-lg mx-auto text-center mb-10 sm:mb-12">
                        <div class="w-14 h-14 sm:w-16 sm:h-16 bg-lbrce-accent/10 text-lbrce-accent rounded-2xl flex items-center justify-center mx-auto mb-6">
                            <i class="ph-bold ph-users-three text-2xl sm:text-3xl"></i>
                        </div>
                        <h2 class="text-2xl sm:text-4xl font-black text-lbrce-blue uppercase tracking-tighter">Team Identity</h2>
                        <p class="text-slate-400 text-[10px] sm:text-sm font-bold uppercase tracking-widest mt-3">Establish your group profile</p>
                    </div>
                    
                    <div class="space-y-6 sm:space-y-8 max-w-md mx-auto">
                        <div class="space-y-2">
                            <label class="block text-[9px] sm:text-[10px] font-black text-slate-400 uppercase ml-4 sm:ml-6 tracking-widest">Team / Group Name</label>
                            <input type="text" name="teamName" required onblur="this.value = formatToTitleCase(this.value)" placeholder="e.g. Cyber Ninjas" class="w-full px-6 sm:px-8 py-4 sm:py-5 rounded-[1.5rem] bg-slate-50 border-2 border-transparent outline-none font-bold text-lbrce-blue transition-all">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-[9px] sm:text-[10px] font-black text-slate-400 uppercase ml-4 sm:ml-6 tracking-widest">Organization / College</label>
                            <div class="relative">
                                <select id="collegeSelect" name="college" required onchange="handleCollegeChange(this)" class="w-full px-6 sm:px-8 py-4 sm:py-5 rounded-[1.5rem] bg-slate-50 border-2 border-transparent outline-none font-bold text-lbrce-blue transition-all appearance-none cursor-pointer">
                                    <option value="">Syncing Organizations...</option>
                                    <option value="OTHER">Other Organization (Manual Entry)</option>
                                </select>
                                <i class="ph-bold ph-caret-down absolute right-6 sm:right-8 top-1/2 -translate-y-1/2 text-slate-300 pointer-events-none"></i>
                            </div>
                        </div>
                        <div id="otherCollegeWrap" class="hidden space-y-2 animate-in slide-in-from-top-2">
                            <label class="block text-[9px] font-black text-orange-500 uppercase ml-4 tracking-widest">Manual Institution Entry</label>
                            <input type="text" id="otherCollegeInput" onblur="this.value = formatToTitleCase(this.value)" placeholder="Enter Full College Name" class="w-full px-6 sm:px-8 py-4 sm:py-5 rounded-[1.5rem] bg-orange-50 border-2 border-orange-100 font-bold text-lbrce-blue outline-none">
                        </div>
                    </div>
                </div>

                <!-- STEP 2: LEADER -->
                <div id="step-2" class="step-content animate-in fade-in slide-in-from-right-6 duration-700">
                    <h2 class="text-2xl sm:text-3xl font-black text-lbrce-blue uppercase tracking-tight mb-10 text-left">Team Captain Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 sm:gap-8 text-left">
                        <div class="space-y-1.5">
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-4">Full Legal Name</label>
                            <input type="text" name="leadName" placeholder="Participant Name" required onblur="this.value = formatToTitleCase(this.value)" class="w-full px-6 py-4 rounded-[1.5rem] bg-slate-50 border-none font-bold outline-none text-lbrce-blue">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-4">Branch / Department</label>
                            <div class="relative">
                                <select id="deptSelect" name="leadDept" required class="w-full px-6 py-4 rounded-[1.5rem] bg-slate-50 border-none font-bold outline-none text-lbrce-blue appearance-none cursor-pointer">
                                    <option value="">Select Department</option>
                                </select>
                                <i class="ph-bold ph-caret-down absolute right-6 top-1/2 -translate-y-1/2 text-slate-300 pointer-events-none"></i>
                            </div>
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-4">Personal Email</label>
                            <input type="email" name="leadEmail" placeholder="email@gmail.com" required class="w-full px-6 py-4 rounded-[1.5rem] bg-slate-50 border-none font-bold outline-none text-lbrce-blue">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-4">WhatsApp Number</label>
                            <input type="tel" name="leadPhone" placeholder="10 Digit Mobile" required class="w-full px-6 py-4 rounded-[1.5rem] bg-slate-50 border-none font-bold outline-none text-lbrce-blue">
                        </div>
                        <div class="space-y-1.5 md:col-span-2">
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-4">College ID / Roll Number</label>
                            <input type="text" name="leadRoll" placeholder="e.g. 21761A0501" required class="w-full px-6 py-4 rounded-[1.5rem] bg-slate-50 border-none font-bold outline-none text-lbrce-blue">
                        </div>
                        <div class="col-span-1 md:col-span-2 pt-4">
                            <div class="bg-slate-50 p-6 rounded-[2rem] border-2 border-dashed border-slate-200 text-center cursor-pointer relative hover:bg-slate-100 transition-all group" onclick="this.querySelector('input').click()">
                                <i class="ph-bold ph-user-focus text-3xl text-slate-300 mb-2 block mx-auto group-hover:text-lbrce-blue"></i>
                                <span id="leadPhotoName" class="text-[10px] font-black text-slate-400 uppercase tracking-widest group-hover:text-lbrce-blue">Select Passport Identity Photo</span>
                                <input type="file" name="leadPhoto" accept="image/*" required class="hidden" onchange="document.getElementById('leadPhotoName').innerText = this.files[0].name">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 3: MEMBERS (DYNAMIC) -->
                <div id="step-3" class="step-content animate-in fade-in slide-in-from-right-6 duration-700">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-10 gap-4">
                        <div class="text-left">
                            <h2 class="text-2xl sm:text-3xl font-black text-lbrce-blue uppercase tracking-tight">Team Roster</h2>
                            <p id="rosterHint" class="text-slate-400 text-[9px] font-bold uppercase tracking-widest mt-1"></p>
                        </div>
                        <button type="button" id="addMemberBtn" onclick="addMemberUI()" class="px-6 py-3 bg-lbrce-accent text-lbrce-blue rounded-xl font-black text-[10px] uppercase tracking-widest shadow-xl hover:scale-105 transition-all flex items-center gap-2 justify-center">
                            <i class="ph-bold ph-user-plus text-lg"></i> Add Member
                        </button>
                    </div>
                    <div id="roster-container" class="space-y-6 text-left">
                        <!-- Dynamic member cards -->
                    </div>
                </div>

                <!-- STEP 4: REVIEW -->
                <div id="step-4" class="step-content animate-in zoom-in-95 duration-700">
                    <h2 class="text-2xl font-black text-lbrce-blue uppercase text-center mb-8 sm:mb-12">Review Registration</h2>
                    
                    <div class="space-y-10">
                        <!-- Summary Header Card -->
                        <div class="bg-lbrce-blue p-8 sm:p-12 rounded-[2.5rem] text-white shadow-2xl relative overflow-hidden">
                            <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/5 rounded-full blur-3xl"></div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 relative z-10 text-left">
                                <div class="space-y-1">
                                    <p class="text-[9px] font-black uppercase text-lbrce-accent tracking-[0.2em]">Team / Group Identity</p>
                                    <p id="review-team" class="text-xl sm:text-2xl font-black uppercase truncate"></p>
                                </div>
                                <div class="space-y-1 text-right">
                                    <p class="text-[9px] font-black uppercase text-lbrce-accent tracking-[0.2em]">Payment Due</p>
                                    <div class="flex items-baseline justify-end gap-1">
                                        <span class="text-base font-bold text-lbrce-accent">â‚¹</span>
                                        <span id="review-price" class="text-4xl font-black">0</span>
                                    </div>
                                </div>
                                <div class="space-y-1 sm:col-span-2 pt-4 border-t border-white/10">
                                    <p class="text-[9px] font-black uppercase text-lbrce-accent tracking-[0.2em]">Organization</p>
                                    <p id="review-college" class="text-sm font-bold opacity-80"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Full Details Breakdown -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Team Captain Info -->
                            <div class="bg-slate-50/50 p-8 rounded-[2rem] border border-slate-100 text-left">
                                <div class="flex items-center gap-4 mb-8">
                                    <div class="w-10 h-10 bg-lbrce-blue rounded-xl flex items-center justify-center text-white"><i class="ph-bold ph-crown text-xl"></i></div>
                                    <p class="text-[10px] font-black uppercase tracking-widest text-lbrce-blue">Captain Data</p>
                                </div>
                                <div id="review-captain-info" class="space-y-4">
                                    <!-- Populated via JS -->
                                </div>
                            </div>

                            <!-- Team Members Table -->
                            <div class="bg-slate-50/50 p-8 rounded-[2rem] border border-slate-100 text-left">
                                <div class="flex items-center gap-4 mb-8">
                                    <div class="w-10 h-10 bg-slate-200 rounded-xl flex items-center justify-center text-slate-500"><i class="ph-bold ph-users-three text-xl"></i></div>
                                    <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Team Roster</p>
                                </div>
                                <div id="review-roster-info" class="space-y-3">
                                    <!-- Populated via JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CONTROLS -->
                <div class="mt-12 sm:mt-20 flex flex-col sm:flex-row gap-4">
                    <button type="button" id="prevBtn" onclick="changeStep(-1)" class="hidden w-full sm:w-auto px-10 py-4 sm:py-5 bg-white border border-slate-200 text-slate-400 rounded-[1.5rem] font-black text-xs uppercase tracking-widest hover:bg-slate-50">Back</button>
                    <button type="button" id="nextBtn" onclick="handleNextClick()" class="flex-1 w-full px-10 py-4 sm:py-5 bg-lbrce-blue text-white rounded-[1.5rem] sm:rounded-[2rem] font-black text-[10px] sm:text-[11px] uppercase tracking-[0.2em] shadow-2xl hover:bg-lbrce-accent hover:text-lbrce-blue transition-all active:scale-95">
                        <span id="next-btn-text">Proceed to Details</span>
                    </button>
                </div>
            </form>
        </div>
        
        <p class="text-center mt-12 text-[9px] font-black text-slate-300 uppercase tracking-[0.4em] leading-relaxed">Official Registration Gateway &copy; 2026 <br> Developed By Xeta Tech Solutions</p>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('event');
        let currentStep = 1, eventData = null, memberIndex = 1;
        let availableDepartments = [];

        function showPopup(title, message, isError = true, callback = null) {
            const popup = document.getElementById('custom-popup');
            const iconWrap = document.getElementById('popup-icon');
            const icon = iconWrap.querySelector('i');
            const btn = document.getElementById('popup-btn');
            
            document.getElementById('popup-title').innerText = title;
            document.getElementById('popup-message').innerText = message;
            
            if(isError) {
                iconWrap.className = "w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center mx-auto mb-6";
                icon.className = "ph-bold ph-warning-circle text-3xl";
                btn.className = "w-full py-4 bg-lbrce-blue text-white rounded-xl font-black text-[10px] uppercase tracking-widest";
            } else {
                iconWrap.className = "w-16 h-16 bg-green-50 text-green-500 rounded-2xl flex items-center justify-center mx-auto mb-6";
                icon.className = "ph-bold ph-check-circle text-3xl";
                btn.className = "w-full py-4 bg-green-600 text-white rounded-xl font-black text-[10px] uppercase tracking-widest";
            }
            
            popup.classList.add('active');
            btn.onclick = () => { closePopup(); if(callback) callback(); };
        }

        function closePopup() {
            document.getElementById('custom-popup').classList.remove('active');
        }

        function formatToTitleCase(str) {
            if (!str) return "";
            return str.trim().toLowerCase().split(/\s+/).map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function handleCollegeChange(sel) {
            document.getElementById('otherCollegeWrap').classList.toggle('hidden', sel.value !== 'OTHER');
        }

        async function init() {
            if (!eventId) { window.location.href = 'index.html'; return; }
            try {
                const [evtRes, masterRes] = await Promise.all([
                    fetch('/api/events'), fetch('/api/master-data')
                ]);
                const evts = await evtRes.json();
                eventData = evts.find(e => e.eventId === eventId);
                const master = await masterRes.json();
                availableDepartments = (master.departments || []).sort();

                const collegeSel = document.getElementById('collegeSelect');
                collegeSel.innerHTML = '<option value="">Select College</option>'; 
                (master.colleges || []).sort().forEach(c => {
                    const o = document.createElement('option');
                    o.value = c; o.textContent = c; collegeSel.appendChild(o);
                });
                const other = document.createElement('option');
                other.value = 'OTHER'; other.textContent = 'Other Organization (Manual Entry)';
                collegeSel.appendChild(other);

                const deptSel = document.getElementById('deptSelect');
                deptSel.innerHTML = '<option value="">Select Department</option>';
                availableDepartments.forEach(d => {
                    const o = document.createElement('option');
                    o.value = d; o.textContent = d; deptSel.appendChild(o);
                });

                document.getElementById('event-tag').classList.remove('hidden');
                document.getElementById('event-name-tag').innerText = eventData.name;
                document.getElementById('review-price').innerText = eventData.price;
                
                const limit = parseInt(eventData.teamSize || 1);
                document.getElementById('rosterHint').innerText = limit > 1 ? `Optional: Add up to ${limit-1} co-members` : "Individual Entry Only";
                if(limit <= 1) document.getElementById('addMemberBtn').classList.add('hidden');
            } catch (err) { console.error("Sync Error"); }
        }

        function addMemberUI() {
            const limit = parseInt(eventData.teamSize || 1);
            if(document.querySelectorAll('.member-card').length >= limit - 1) {
                return showPopup("Limit Exceeded", "This event restricts team rosters to a maximum of " + limit + " participants.");
            }
            memberIndex++;
            const id = memberIndex;
            const card = document.createElement('div');
            card.className = "member-card p-6 sm:p-10 bg-slate-50/40 rounded-[2rem] border border-slate-100 grid grid-cols-1 md:grid-cols-2 gap-5 sm:gap-8 relative group animate-in slide-in-from-bottom-2";
            card.id = `mem-row-${id}`;
            const deptOptions = availableDepartments.map(d => `<option value="${d}">${d}</option>`).join('');

            card.innerHTML = `
                <button type="button" onclick="this.parentElement.remove()" class="absolute -top-3 -right-3 w-10 h-10 bg-red-500 text-white rounded-xl shadow-lg flex items-center justify-center hover:scale-110 transition-all"><i class="ph-bold ph-trash"></i></button>
                <div class="space-y-1.5 text-left">
                    <label class="text-[9px] font-black text-slate-400 uppercase ml-4">Full Name</label>
                    <input type="text" name="m${id}_name" required onblur="this.value = formatToTitleCase(this.value)" class="w-full px-5 py-3.5 rounded-xl bg-white border-none font-bold text-sm text-lbrce-blue">
                </div>
                <div class="space-y-1.5 text-left">
                    <label class="text-[9px] font-black text-slate-400 uppercase ml-4">Department</label>
                    <select name="m${id}_dept" required class="w-full px-5 py-3.5 rounded-xl bg-white border-none font-bold text-sm text-lbrce-blue cursor-pointer">
                        <option value="">Select Dept</option>${deptOptions}
                    </select>
                </div>
                <div class="space-y-1.5 text-left">
                    <label class="text-[9px] font-black text-slate-400 uppercase ml-4">Roll Number</label>
                    <input type="text" name="m${id}_roll" required class="w-full px-5 py-3.5 rounded-xl bg-white border-none font-bold text-sm text-lbrce-blue">
                </div>
                <div class="space-y-1.5 text-left">
                    <label class="text-[9px] font-black text-slate-400 uppercase ml-4">Personal Email</label>
                    <input type="email" name="m${id}_email" required class="w-full px-5 py-3.5 rounded-xl bg-white border-none font-bold text-sm text-lbrce-blue">
                </div>
                <input type="tel" name="m${id}_phone" placeholder="WhatsApp Number" required class="w-full px-5 py-3.5 rounded-xl bg-white border-none font-bold text-sm text-lbrce-blue md:col-span-2 mt-4">
                <div class="md:col-span-2 pt-2 text-left">
                    <input type="file" name="m${id}_photo" accept="image/*" required class="w-full px-5 py-2.5 rounded-xl bg-white border-none font-bold text-[10px] text-slate-400">
                </div>
            `;
            document.getElementById('roster-container').appendChild(card);
        }

        function handleNextClick() {
            if (currentStep === 4) processRegistration();
            else changeStep(1);
        }

        async function changeStep(dir) {
            if(dir === 1) {
                if(!validateStep()) return;

                if(currentStep === 2 || currentStep === 3) {
                    const btn = document.getElementById('nextBtn');
                    const originalText = document.getElementById('next-btn-text').innerText;
                    document.getElementById('next-btn-text').innerText = "VERIFYING CLOUD...";
                    btn.disabled = true;

                    try {
                        const identifiers = [];
                        if(currentStep === 2) {
                            identifiers.push(document.getElementsByName('leadEmail')[0].value);
                            identifiers.push(document.getElementsByName('leadRoll')[0].value);
                        } else {
                            document.querySelectorAll('.member-card').forEach(card => {
                                const id = card.id.split('-').pop();
                                identifiers.push(card.querySelector(`input[name="m${id}_email"]`).value);
                                identifiers.push(card.querySelector(`input[name="m${id}_roll"]`).value);
                            });
                        }

                        const res = await fetch('/api/register/check-duplicates', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ eventId: eventData.eventId, identifiers })
                        });
                        const status = await res.json();
                        if(status.exists) {
                            showPopup("Identity Conflict", `The identifier "${status.conflict}" is already registered for this event. Duplicate entries are blocked.`);
                            btn.disabled = false;
                            document.getElementById('next-btn-text').innerText = originalText;
                            return;
                        }
                    } catch (e) { console.error("Integrity check failed"); }
                    finally {
                        btn.disabled = false;
                        document.getElementById('next-btn-text').innerText = originalText;
                    }
                }
            }
            
            const next = currentStep + dir;
            if(next < 1 || next > 4) return;
            
            document.getElementById(`step-${currentStep}`).classList.remove('active');
            document.getElementById(`step-${next}`).classList.add('active');
            document.getElementById('progress-bar').style.width = (next * 25) + '%';
            document.getElementById('prevBtn').style.display = next > 1 ? 'block' : 'none';
            
            const btnText = document.getElementById('next-btn-text');
            const map = { 1: "Proceed to Captain Details", 2: "Proceed to Member Roster", 3: "Review Registration Data", 4: "Confirm & Secure Payment" };
            btnText.innerText = map[next];

            if(next === 4) {
                const collegeSel = document.getElementById('collegeSelect').value;
                document.getElementById('review-team').innerText = document.getElementsByName('teamName')[0].value;
                document.getElementById('review-college').innerText = collegeSel === 'OTHER' ? document.getElementById('otherCollegeInput').value : collegeSel;
                
                const leadName = document.getElementsByName('leadName')[0].value;
                const leadDept = document.getElementById('deptSelect').value;
                const leadRoll = document.getElementsByName('leadRoll')[0].value;
                const leadEmail = document.getElementsByName('leadEmail')[0].value;
                const leadPhone = document.getElementsByName('leadPhone')[0].value;

                document.getElementById('review-captain-info').innerHTML = `
                    <div class="flex justify-between border-b border-slate-200 pb-2"><span class="text-[10px] text-slate-400 font-bold uppercase">Full Name</span><span class="text-xs font-black text-lbrce-blue">${leadName}</span></div>
                    <div class="flex justify-between border-b border-slate-200 pb-2"><span class="text-[10px] text-slate-400 font-bold uppercase">Department</span><span class="text-xs font-black text-lbrce-blue">${leadDept}</span></div>
                    <div class="flex justify-between border-b border-slate-200 pb-2"><span class="text-[10px] text-slate-400 font-bold uppercase">Roll No</span><span class="text-xs font-black text-lbrce-blue">${leadRoll}</span></div>
                    <div class="flex flex-col gap-1"><span class="text-[10px] text-slate-400 font-bold uppercase">Lead Contact</span><span class="text-xs font-black text-lbrce-blue truncate">${leadEmail} / ${leadPhone}</span></div>
                `;

                const rosterInfo = document.getElementById('review-roster-info');
                const memberCards = document.querySelectorAll('.member-card');
                if(memberCards.length === 0) {
                    rosterInfo.innerHTML = `<div class="py-10 text-center"><p class="text-[10px] font-bold text-slate-300 uppercase tracking-widest">Individual Entry Profile</p></div>`;
                } else {
                    rosterInfo.innerHTML = Array.from(memberCards).map(card => {
                        const id = card.id.split('-').pop();
                        const name = card.querySelector(`input[name="m${id}_name"]`).value;
                        const dept = card.querySelector(`select[name="m${id}_dept"]`).value;
                        return `<div class="p-3 bg-white rounded-xl border border-slate-200 flex items-center justify-between"><div class="text-left"><p class="text-xs font-black text-lbrce-blue">${name}</p><p class="text-[8px] font-bold text-slate-400 uppercase mt-1 tracking-widest">${dept}</p></div><i class="ph-bold ph-check text-green-500"></i></div>`;
                    }).join('');
                }
            }
            currentStep = next;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function validateStep() {
            const step = document.getElementById(`step-${currentStep}`);
            const inputs = step.querySelectorAll('input[required], select[required]');
            let valid = true;
            for(let i of inputs) {
                if(!i.value.trim()) { i.classList.add('ring-2', 'ring-red-500'); valid = false; }
                else { i.classList.remove('ring-2', 'ring-red-500'); }
            }
            if(!valid) showPopup("Missing Data", "Please complete all mandatory fields before moving to the next stage.");
            return valid;
        }

        async function uploadHelper(file) {
            if(!file) return null;
            const formData = new FormData(); formData.append('photo', file);
            const res = await fetch('/api/upload-photo', { method: 'POST', body: formData });
            const json = await res.json(); return json.url;
        }

        async function processRegistration() {
            const btn = document.getElementById('nextBtn');
            btn.disabled = true; btn.innerText = "SYNCHRONIZING ASSETS...";
            try {
                const form = document.getElementById('multiStepForm');
                const leadPhotoUrl = await uploadHelper(form.querySelector('input[name="leadPhoto"]').files[0]);
                const members = [];
                for(let card of document.querySelectorAll('.member-card')) {
                    const id = card.id.split('-').pop();
                    members.push({
                        name: card.querySelector(`input[name="m${id}_name"]`).value,
                        dept: card.querySelector(`select[name="m${id}_dept"]`).value,
                        email: card.querySelector(`input[name="m${id}_email"]`).value,
                        phone: card.querySelector(`input[name="m${id}_phone"]`).value,
                        roll: card.querySelector(`input[name="m${id}_roll"]`).value,
                        photoUrl: await uploadHelper(card.querySelector(`input[type="file"]`).files[0])
                    });
                }

                const collegeSel = document.getElementById('collegeSelect').value;
                const registrationData = {
                    eventId: eventData.eventId, eventName: eventData.name,
                    teamName: form.querySelector('input[name="teamName"]').value,
                    college: collegeSel === 'OTHER' ? document.getElementById('otherCollegeInput').value : collegeSel,
                    department: document.getElementById('deptSelect').value,
                    leadName: form.querySelector('input[name="leadName"]').value,
                    leadEmail: form.querySelector('input[name="leadEmail"]').value,
                    leadPhone: form.querySelector('input[name="leadPhone"]').value,
                    leadRoll: form.querySelector('input[name="leadRoll"]').value,
                    photoUrl: leadPhotoUrl, members, amount: parseFloat(eventData.price || 0)
                };

                const orderRes = await fetch('/api/register/create-order', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ amount: registrationData.amount }) });
                const order = await orderRes.json();

                new Razorpay({
                    key: "rzp_test_SBYJMDaXO4aRid", amount: order.amount, currency: "INR", order_id: order.id,
                    handler: async (response) => {
                        btn.innerText = "FINALIZING REGISTRY...";
                        const verifyRes = await fetch('/api/register/verify', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ ...response, registrationData }) });
                        const vJson = await verifyRes.json();
                        if(vJson.success) {
                            showPopup("Success!", "Registration Secured. A confirmation report and ID card have been sent to your email.", false, () => {
                                window.location.href = `status.html?id=${vJson.registrationId}`;
                            });
                        }
                    },
                    modal: { ondismiss: () => { btn.disabled = false; btn.innerText = "Confirm & Secure Payment"; } }
                }).open();
            } catch (e) { btn.disabled = false; btn.innerText = "Retry Secure Payment"; }
        }
        init();
    </script>
</body>
</html>