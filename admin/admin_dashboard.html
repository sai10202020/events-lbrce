<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Dashboard | LBRCE Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: { lbrce: { blue: '#003366', accent: '#FFB800' } }
                }
            }
        }
    </script>
    <style>
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .sidebar-item-active { background: #FFB800 !important; color: #003366 !important; box-shadow: 0 10px 15px -3px rgba(255, 184, 0, 0.3); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        /* Mobile Sidebar Toggle Logic */
        #sidebar-toggle:checked ~ aside { transform: translateX(0); }
        @media (max-width: 1024px) {
            aside { transform: translateX(-100%); transition: transform 0.3s ease; }
        }
    </style>
</head>
<body class="bg-[#F8FAFC] flex h-screen overflow-hidden text-slate-700">

    <!-- Mobile Toggle Input (Hidden) -->
    <input type="checkbox" id="sidebar-toggle" class="hidden">

    <!-- SIDEBAR -->
    <aside class="fixed lg:static inset-y-0 left-0 w-72 bg-lbrce-blue text-white flex flex-col shrink-0 shadow-2xl z-50">
        <div class="p-8 flex flex-col items-center">
            <div class="w-20 h-20 bg-white rounded-2xl p-3 mb-4 shadow-xl border border-white/10 flex items-center justify-center">
                <img src="https://res.cloudinary.com/djdwpjm7x/image/upload/v1769925973/events_lbrce_logo_sefvzr.png" 
                     alt="LBRCE Logo" 
                     class="max-w-full max-h-full object-contain">
            </div>
            <h1 class="text-lg font-black tracking-tight uppercase">Admin Console</h1>
            <p class="text-[9px] font-bold text-white/40 uppercase tracking-[0.3em] mt-1">LBRCE Events Portal</p>
        </div>

        <nav class="flex-1 px-4 space-y-1 overflow-y-auto">
            <a href="admin_dashboard.html" class="sidebar-item-active flex items-center gap-4 px-5 py-3.5 rounded-xl font-bold text-sm transition-all">
                <i class="ph-bold ph-squares-four text-xl"></i> Analytics
            </a>
            <a href="admin_manage_events.html" class="flex items-center gap-4 px-5 py-3.5 rounded-xl font-bold text-sm text-white/60 hover:text-white hover:bg-white/5 transition-all">
                <i class="ph-bold ph-calendar-plus text-xl"></i> Manage Events
            </a>
            <a href="admin_registrations.html" class="flex items-center gap-4 px-5 py-3.5 rounded-xl font-bold text-sm text-white/60 hover:text-white hover:bg-white/5 transition-all">
                <i class="ph-bold ph-users-three text-xl"></i> Registrations
            </a>
            <a href="admin_scanner.html" class="flex items-center gap-4 px-5 py-3.5 rounded-xl font-bold text-sm text-white/60 hover:text-white hover:bg-white/5 transition-all">
                <i class="ph-bold ph-qr-code text-xl"></i> Attendance
            </a>
            <a href="admin_certificates.html" class="flex items-center gap-4 px-5 py-3.5 rounded-xl font-bold text-sm text-white/60 hover:text-white hover:bg-white/5 transition-all">
                <i class="ph-bold ph-certificate text-xl"></i> Certificates
            </a>
        </nav>

        <div class="p-6 border-t border-white/5">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 py-3.5 bg-white/5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-red-500 transition-all">
                <i class="ph ph-power text-lg"></i> Sign Out
            </button>
        </div>
    </aside>

    <!-- Overlay for mobile -->
    <label for="sidebar-toggle" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden" id="mobile-overlay"></label>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col overflow-hidden w-full">
        <!-- HEADER -->
        <header class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-100 flex items-center justify-between px-6 lg:px-10 shrink-0">
            <div class="flex items-center gap-4">
                <label for="sidebar-toggle" class="lg:hidden p-2 bg-slate-100 rounded-lg cursor-pointer hover:bg-lbrce-accent transition-colors">
                    <i class="ph-bold ph-list text-xl text-lbrce-blue"></i>
                </label>
                <div>
                    <h2 class="text-xl lg:text-2xl font-black text-lbrce-blue uppercase tracking-tight">Overview</h2>
                    <p id="current-date" class="hidden sm:block text-[10px] font-bold text-slate-400 uppercase tracking-wider"></p>
                </div>
            </div>
            
            <div class="flex items-center gap-3 lg:gap-4">
                <div class="hidden sm:block text-right">
                    <p class="text-[10px] font-black text-lbrce-blue uppercase">Super Admin</p>
                    <div class="flex items-center justify-end gap-1.5">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                        <p class="text-[9px] font-bold text-green-600 uppercase tracking-widest">Online</p>
                    </div>
                </div>
                <div class="w-10 h-10 lg:w-12 lg:h-12 bg-slate-100 rounded-xl border-2 border-white shadow-sm flex items-center justify-center text-lbrce-blue overflow-hidden">
                    <i class="ph-bold ph-user-circle text-2xl"></i>
                </div>
            </div>
        </header>

        <!-- DASHBOARD BODY -->
        <div class="flex-1 overflow-y-auto p-4 lg:p-10 space-y-6 lg:space-y-10">
            <!-- STATS GRID -->
            <div id="stats-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-8">
                <!-- Data populated via script -->
                <div class="animate-pulse bg-white h-24 lg:h-32 rounded-3xl border"></div>
                <div class="animate-pulse bg-white h-24 lg:h-32 rounded-3xl border"></div>
                <div class="animate-pulse bg-white h-24 lg:h-32 rounded-3xl border"></div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 lg:gap-10">
                <!-- CHART -->
                <div class="xl:col-span-2 bg-white p-6 lg:p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h3 class="text-lg font-black text-lbrce-blue uppercase tracking-tight leading-none">Registrations</h3>
                            <p class="text-[10px] font-bold text-slate-400 uppercase mt-1">Activity per day</p>
                        </div>
                        <div class="flex gap-2">
                            <span class="px-3 py-1.5 bg-lbrce-blue text-white text-[9px] font-black rounded-lg uppercase tracking-wider cursor-pointer">Live View</span>
                        </div>
                    </div>
                    <div class="h-64 lg:h-80">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>

                <!-- RECENT ACTIVITY -->
                <div class="bg-white p-6 lg:p-8 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col h-full max-h-[500px] lg:max-h-none">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-black text-lbrce-blue uppercase tracking-tight">Recent Log</h3>
                        <i class="ph-bold ph-lightning text-lbrce-accent text-xl"></i>
                    </div>
                    
                    <div id="recent-activity" class="flex-1 space-y-4 overflow-y-auto pr-2">
                        <div class="text-center py-10 text-slate-400 font-bold text-xs uppercase italic">Syncing data...</div>
                    </div>

                    <a href="admin_registrations.html" class="mt-6 flex items-center justify-center gap-2 py-4 bg-slate-50 rounded-2xl text-[10px] font-black text-lbrce-blue uppercase tracking-widest hover:bg-lbrce-accent transition-all group">
                        Manage All Data <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </a>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Update current date
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });

        // Mobile overlay behavior
        document.getElementById('sidebar-toggle').addEventListener('change', function() {
            const overlay = document.getElementById('mobile-overlay');
            if(this.checked) overlay.classList.remove('hidden');
            else overlay.classList.add('hidden');
        });

        async function loadDashboard() {
            try {
                // 1. FETCH STATS
                const res = await fetch('/api/admin/stats');
                
                // AUTH CHECK
                if (res.status === 401 || res.status === 403) {
                    window.location.href = 'admin_login.html';
                    return;
                }
                
                const stats = await res.json();
                
                // Render Stats Grid
                const grid = document.getElementById('stats-grid');
                grid.innerHTML = `
                    <div class="bg-white p-6 lg:p-8 rounded-3xl border border-slate-100 shadow-xl shadow-slate-900/5 flex items-center gap-6 group hover:border-lbrce-accent transition-all">
                        <div class="w-12 h-12 lg:w-16 lg:h-16 bg-blue-50 text-lbrce-blue rounded-2xl flex items-center justify-center text-2xl lg:text-3xl group-hover:bg-lbrce-blue group-hover:text-white transition-all">
                            <i class="ph-bold ph-user-plus"></i>
                        </div>
                        <div>
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-0.5">Participants</p>
                            <h4 class="text-2xl lg:text-4xl font-black text-lbrce-blue leading-none">${stats.registrationCount || 0}</h4>
                        </div>
                    </div>
                    <div class="bg-white p-6 lg:p-8 rounded-3xl border border-slate-100 shadow-xl shadow-slate-900/5 flex items-center gap-6 group hover:border-lbrce-accent transition-all">
                        <div class="w-12 h-12 lg:w-16 lg:h-16 bg-green-50 text-green-600 rounded-2xl flex items-center justify-center text-2xl lg:text-3xl group-hover:bg-green-600 group-hover:text-white transition-all">
                            <i class="ph-bold ph-coins"></i>
                        </div>
                        <div>
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-0.5">Event Revenue</p>
                            <h4 class="text-2xl lg:text-4xl font-black text-lbrce-blue leading-none">₹${stats.revenue || 0}</h4>
                        </div>
                    </div>
                    <div class="bg-white p-6 lg:p-8 rounded-3xl border border-slate-100 shadow-xl shadow-slate-900/5 flex items-center gap-6 group hover:border-lbrce-accent transition-all">
                        <div class="w-12 h-12 lg:w-16 lg:h-16 bg-orange-50 text-orange-600 rounded-2xl flex items-center justify-center text-2xl lg:text-3xl group-hover:bg-orange-600 group-hover:text-white transition-all">
                            <i class="ph-bold ph-lightning"></i>
                        </div>
                        <div>
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-0.5">Live Events</p>
                            <h4 class="text-2xl lg:text-4xl font-black text-lbrce-blue leading-none">${stats.eventCount || 0}</h4>
                        </div>
                    </div>
                `;

                // 2. FETCH REGISTRATIONS & EVENTS (Parallel Fetch for Speed)
                const [regRes, evtRes] = await Promise.all([
                    fetch('/api/admin/registrations'),
                    fetch('/api/events')
                ]);

                let regs = [];
                let events = [];

                if (regRes.ok) regs = await regRes.json();
                if (evtRes.ok) events = await evtRes.json();

                // 3. CREATE EVENT ID -> NAME LOOKUP MAP
                // This fixes the issue where eventName might be undefined in the registration object
                const eventMap = {};
                if (Array.isArray(events)) {
                    events.forEach(e => {
                        eventMap[e.eventId] = e.name;
                    });
                }

                if (!Array.isArray(regs)) {
                    console.error("Expected array for registrations, got:", regs);
                    regs = []; 
                }
                
                // Pass the lookup map to the populate function
                populateActivity(regs.slice(0, 8), eventMap);
                renderChart();
                
            } catch (err) { 
                console.error("Dashboard Sync Error:", err); 
            }
        }

        function populateActivity(regs, eventMap) {
            const container = document.getElementById('recent-activity');
            if(!regs || regs.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-400 py-10 font-bold uppercase text-[9px]">No data logged yet</p>`;
                return;
            }
            container.innerHTML = regs.map(r => {
                // FALLBACK LOGIC: 
                // 1. Try r.eventName
                // 2. If undefined, try eventMap[r.eventId]
                // 3. If still not found, show 'Unknown Event'
                const displayEventName = (r.eventName && r.eventName !== 'undefined') 
                    ? r.eventName 
                    : (eventMap[r.eventId] || 'Unknown Event ID');

                return `
                <div class="flex items-center gap-3 p-3.5 rounded-2xl bg-slate-50 border border-transparent hover:border-lbrce-accent hover:bg-white hover:shadow-lg hover:shadow-slate-200/50 transition-all cursor-default">
                    <div class="w-9 h-9 rounded-xl bg-white border shadow-sm flex items-center justify-center overflow-hidden shrink-0">
                        ${r.photoUrl ? `<img src="${r.photoUrl}" class="w-full h-full object-cover">` : `<i class="ph ph-user text-slate-300"></i>`}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[10px] font-black text-lbrce-blue uppercase truncate">${r.leadName}</p>
                        <p class="text-[8px] font-bold text-slate-400 uppercase truncate">${displayEventName}</p>
                    </div>
                    <div class="text-right shrink-0">
                        <p class="text-[10px] font-black text-slate-700">₹${r.amount}</p>
                    </div>
                </div>
            `}).join('');
        }

        function renderChart() {
            const ctx = document.getElementById('statsChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(0, 51, 102, 0.15)');
            gradient.addColorStop(1, 'rgba(0, 51, 102, 0)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Registrations',
                        data: [15, 28, 12, 45, 30, 65, 52], // Placeholder data
                        borderColor: '#003366',
                        borderWidth: 4,
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#FFB800',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 4,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            display: true, 
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: { font: { weight: 'bold', size: 9 }, color: '#94a3b8' }
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { font: { weight: 'bold', size: 9 }, color: '#94a3b8' } 
                        }
                    }
                }
            });
        }

        async function logout() {
            window.location.href = 'admin_login.html';
        }

        window.onload = loadDashboard;
    </script>
</body>
</html>
