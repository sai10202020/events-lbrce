<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Data Control | LBRCE Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: { lbrce: { blue: '#003366', accent: '#FFB800' } }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .item-row { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .delete-btn { opacity: 0.4; }
        @media (hover: hover) { .item-row:hover .delete-btn { opacity: 1; transform: scale(1.1); } }
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.7); backdrop-filter: blur(4px); z-index: 50; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-[#F8FAFC] min-h-screen text-slate-700 font-sans">

    <div id="loader" class="loading-overlay">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-slate-200 border-t-lbrce-accent rounded-full animate-spin"></div>
            <p class="text-[10px] font-black uppercase tracking-widest text-lbrce-blue">Syncing Registry...</p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-6 lg:p-12 space-y-12">
        <header class="flex flex-col sm:flex-row justify-between items-center bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 gap-6">
            <div class="flex items-center gap-5 text-left w-full">
                <div class="w-16 h-16 bg-lbrce-blue rounded-[1.5rem] flex items-center justify-center text-white text-3xl">
                    <i class="ph-bold ph-database"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black text-lbrce-blue uppercase tracking-tighter">Registry Engine</h1>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mt-2">Master Data Control Panel</p>
                </div>
            </div>
            <div class="flex gap-3 w-full sm:w-auto">
                <a href="admin_dashboard.html" class="flex-1 sm:flex-none text-center px-8 py-4 bg-slate-100 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-lbrce-blue hover:text-white transition-all">Dashboard</a>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <!-- ORGANIZATIONS -->
            <div class="bg-white p-8 rounded-[3.5rem] border border-slate-100 shadow-2xl space-y-8 flex flex-col h-[700px]">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-black text-lbrce-blue uppercase tracking-tight">Organizations</h3>
                        <p id="collegeCount" class="text-[9px] font-black text-slate-300 uppercase mt-1">0 Colleges</p>
                    </div>
                    <button onclick="document.getElementById('collegeExcel').click()" class="flex items-center gap-2 px-5 py-2.5 bg-green-50 text-green-700 rounded-xl border border-green-100 text-[10px] font-black uppercase tracking-widest">
                        <i class="ph-bold ph-microsoft-excel text-lg"></i> Import
                    </button>
                    <input type="file" id="collegeExcel" class="hidden" accept=".xlsx, .xls" onchange="handleExcel(this, 'colleges')">
                </div>
                <div class="flex gap-2">
                    <input type="text" id="newCollege" placeholder="College Name" class="flex-1 px-6 py-4 rounded-2xl bg-slate-50 border-none outline-none font-bold text-sm">
                    <button onclick="liveAddItem('colleges')" class="w-14 h-14 bg-lbrce-blue text-white rounded-2xl flex items-center justify-center shadow-xl shrink-0"><i class="ph-bold ph-plus text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto pr-2 space-y-2 custom-scrollbar" id="collegeList"></div>
            </div>

            <!-- DEPARTMENTS -->
            <div class="bg-white p-8 rounded-[3.5rem] border border-slate-100 shadow-2xl space-y-8 flex flex-col h-[700px]">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-black text-lbrce-blue uppercase tracking-tight">Departments</h3>
                        <p id="deptCount" class="text-[9px] font-black text-slate-300 uppercase mt-1">0 Departments</p>
                    </div>
                    <button onclick="document.getElementById('deptExcel').click()" class="flex items-center gap-2 px-5 py-2.5 bg-green-50 text-green-700 rounded-xl border border-green-100 text-[10px] font-black uppercase tracking-widest">
                        <i class="ph-bold ph-microsoft-excel text-lg"></i> Import
                    </button>
                    <input type="file" id="deptExcel" class="hidden" accept=".xlsx, .xls" onchange="handleExcel(this, 'departments')">
                </div>
                <div class="flex gap-2">
                    <input type="text" id="newDept" placeholder="Department Name" class="flex-1 px-6 py-4 rounded-2xl bg-slate-50 border-none outline-none font-bold text-sm">
                    <button onclick="liveAddItem('departments')" class="w-14 h-14 bg-lbrce-blue text-white rounded-2xl flex items-center justify-center shadow-xl shrink-0"><i class="ph-bold ph-plus text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto pr-2 space-y-2 custom-scrollbar" id="deptList"></div>
            </div>
        </div>
    </div>

    <script>
        let masterData = { colleges: [], departments: [] };

        function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

        function formatToTitleCase(str) {
            return str.trim().toLowerCase().split(/\s+/).map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        async function loadData() {
            showLoader(true);
            try {
                const res = await fetch('/api/admin/master-data');
                if (res.status === 403) {
                    alert("Session Expired. Please log in again.");
                    window.location.href = 'admin_login.html';
                    return;
                }
                const data = await res.json();
                masterData.colleges = data.colleges || [];
                masterData.departments = data.departments || [];
                renderLists();
            } catch (e) { alert("Connection error with Cloud Registry."); }
            finally { showLoader(false); }
        }

        function renderLists() {
            const render = (list, containerId, type) => {
                const container = document.getElementById(containerId);
                const countBadge = document.getElementById(type === 'colleges' ? 'collegeCount' : 'deptCount');
                countBadge.innerText = `${list.length} Records Registered`;
                if(list.length === 0) {
                    container.innerHTML = `<div class="py-20 text-center text-slate-300 font-bold uppercase text-[10px] tracking-widest">No Items</div>`;
                    return;
                }
                const sorted = [...list].sort((a, b) => a.localeCompare(b));
                container.innerHTML = sorted.map((item) => `
                    <div class="item-row flex items-center justify-between p-5 bg-white rounded-2xl border border-slate-100 hover:border-lbrce-accent transition-all group">
                        <div class="flex items-center gap-4 text-left">
                            <div class="w-2 h-2 rounded-full bg-slate-200 group-hover:bg-lbrce-accent shrink-0"></div>
                            <span class="text-xs font-black text-lbrce-blue uppercase tracking-tight">${item}</span>
                        </div>
                        <button onclick="confirmLiveRemove('${type}', '${item.replace(/'/g, "\\'")}')" class="delete-btn w-9 h-9 rounded-xl bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white shrink-0">
                            <i class="ph-bold ph-trash"></i>
                        </button>
                    </div>
                `).join('');
            };
            render(masterData.colleges, 'collegeList', 'colleges');
            render(masterData.departments, 'deptList', 'departments');
        }

        async function liveAddItem(type) {
            const input = type === 'colleges' ? document.getElementById('newCollege') : document.getElementById('newDept');
            const val = formatToTitleCase(input.value);
            if(!val) return;
            showLoader(true);
            try {
                const res = await fetch('/api/admin/master-data/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type, value: val })
                });
                const result = await res.json();
                if(result.success) { masterData[type] = result.list; input.value = ''; renderLists(); }
            } catch (err) { alert("Failed to add."); }
            finally { showLoader(false); }
        }

        async function confirmLiveRemove(type, value) {
            if(!confirm(`Delete "${value}"?`)) return;
            showLoader(true);
            try {
                const res = await fetch('/api/admin/master-data/remove', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type, value })
                });
                const result = await res.json();
                if(result.success) { masterData[type] = result.list; renderLists(); }
            } catch (err) { alert("Removal failed."); }
            finally { showLoader(false); }
        }

        function handleExcel(input, type) {
            const file = input.files[0];
            if(!file) return;
            showLoader(true);
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                    const newItems = json.flat().filter(i => i && String(i).trim()).map(i => formatToTitleCase(String(i)));
                    const updatedList = [...new Set([...masterData[type], ...newItems])];
                    const res = await fetch('/api/admin/master-data/batch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ type, items: updatedList })
                    });
                    const result = await res.json();
                    if(result.success) { masterData[type] = result.list; renderLists(); alert("Import successful."); }
                } catch (err) { alert("Excel Error."); }
                finally { input.value = ''; showLoader(false); }
            };
            reader.readAsArrayBuffer(file);
        }

        window.onload = loadData;
    </script>
</body>
</html>